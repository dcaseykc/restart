# this install is different from
FROM continuumio/miniconda3 as continuum
# this has the incorrect install and just grabs latest
# It also has an error in install where it says /opt/conda but is really
# /usr/local
# FROM conda/miniconda3 AS conda
FROM restartus/restart AS restart

FROM gitpod/workspace-full
LABEL maintainer="Restart Us <admin@restart.us>"
# Set environment for setup
ARG CONDA_ENV=restart
# must use numbers for this gitpod override in makefile
ARG DOCKER_USER=gitpod
ARG DOCKER_UID=33333

# To be used in gitpod.io must be debian/ubuntu or alpine based
# Must also have a gitpod use
# With the jupyter/scipy-notebook base we end up with two users
# gitpod and joyvan
include(lib/lib.docker)

# if you can figure out where apt-get installs
# this could also become
# FROM restart/debug AS debug
# Then in the current container
# COPY --from=debug /usr/bin /usr/bin
include(lib/debug.docker)

# Testing copies this currently generates an error
# because the current miniconda puts things in the wrong place
# COPY --from=conda /opt/conda /opt/conda-from
COPY --chown=$DOCKER_USER:$DOCKER_USER --from=continuum /opt/conda /opt/conda
ENV PATH /opt/conda/bin:$PATH
RUN mkdir -p /opt/restart/bin
COPY --chown=$DOCKER_USER:$DOCKER_USER --from=restart /usr/bin/make /opt/restart/bin
COPY --chown=$DOCKER_USER:$DOCKER_USER --from=restart /usr/bin/vi /opt/restart/bin
COPY --chown=$DOCKER_USER:$DOCKER_USER --from=restart /usr/sbin/gosu /opt/restart/bin

USER $DOCKER_USER
ENV PATH /opt/conda/bin:$PATH
create_conda($CONDA_ENV,$PYTHON,$PIP,$PIP_ONLY)


set_env($DOCKER_USER,$CONDA_ENV)

WORKDIR /home/$DOCKER_USER/workspace
USER $DOCKER_USER
