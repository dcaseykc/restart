FROM restartus/src:latest
LABEL MAINTAINER="Admin Restart<admin@restart.us>"
# Set environment for setup
ENV ENV=docker

# To be used in gitpod.io must be debian/ubuntu or alpine based
# Must also have a gitpod use
# With the jupyter/scipy-notebook base we end up with two users
# gitpod and joyvan
include(lib/lib.docker)
include(lib/debug.docker)
include(restart/src.docker)
include(nb/nb.docker)

# create the environment for the joyvan user which is used for notebooks
# note that conda does an init here but it is for the joyvan identity
create_conda_nb(nb)

# this creation is required for gitpod so we have the right gitpod
# https://github.com/gitpod-io/workspace-images/blob/master/full/Dockerfile
# '-l': see https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#user
create_user(gitpod,gitpod,33333)
# all the conda files owned by jupyter:users so add to the group
add_group(users,gitpod)
# which will use the source package

# conda init does not work in a bash script
# https://stackoverflow.com/questions/55507519/python-activate-conda-env-through-shell-script
#
     # source "$HOME/.bashrc" && \  # does not work
USER gitpod
RUN  echo "export ENV=docker" >> $HOME/.bashrc && \
     conda init && \
     eval "$(command conda 'shell.bash' 'hook' 2>/dev/null)" && \
     conda activate src
